# Protoc-Gen-CGo
This plugin takes as an input Protobuf file and generates a CGo code appropriately.
> Plugin was written with `Protoc-Gen-Star (PG*)` tool.

Please note that this plugin requires additoinal changes in Protobuf file (more in **Additional changes** section).

## Build
To build this plugin, go inside folder `protoc-gen-cgo` and run following command:

`go build -v -o ./protoc-gen-cgo`

It would build a `protoc-gen-cgo` plugin.

## Usage
To use this plugin please run Protobuf compiler on `*.proto` files you want to process in the following way:

`protoc -I="." --plugin="./protoc-gen-cgo" --cgo_out="./generated" *.proto`

Here are the parameters you should pass:

- `-I="..."` specifies path to the imports in `.proto` file(s)

- `--plugin="..."` specifies path to your custom plugin if it is not located in one of the folders in `$PATH`

- `--cgo_out="..."` specifies path where to store generated files

- `*.proto` is a path to the source `.proto` file(s) to process

## Additonal changes
To ensure that this plugin works correctly you should make some changes to source `.proto` file(s). 
#### Message
Please add `[json_name="..."]` tag 
and put in as an argument appropriate `C-struct Name` (which was generated with `ASN1C` tool) and `C-struct Leaf Name` for all data structures in each `.proto` file
you want to process.   
In the end it should look similar to following example:

```protobuf
message TriggerConditionIeItem {
  RtPeriodIe report_period_ie = 1 [json_name = "Trigger-ConditionIE-Item:report_Period_IE"];
};
```

#### Enum
In the header of an `Enum` type should be added a name of the corresponding `.h` file within `{}` parenthesis. See example below:
```protobuf
// {RT-Period-IE}
enum RtPeriodIe {
  ...
}
```

**This is a temporary solution and would be reconsidered with the future updates.**

## Troubleshooting

#### Post-processing errors caused by `GoFmt()`
In some cases, plugin could raise an error during post-processing of generated files. Unfortunately it doesn't provide much information to debug it. 
In this case please comment `line 21` in `main.go`, recompile the plugin and run it again to generate files.
Once it's done, run following command on generated files to get all errors GoFmt() raises:
`gofmt -w generated/*.go`

Possible causes:
1. `Protobuf` file misses some fields you should provide in `[json_name]` tag (see section **Additional changes**)
2. Template file generates some peaces of code which could be hard to distinguish (two lines were not split, etc.)

#### Other errors
If you have found an error which was not covered there, a good place to track the root cause could be looking into the log output generated by the plugin. 
In this case please refer to the file `/tmp/report.txt`.